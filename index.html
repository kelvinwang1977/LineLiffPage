<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>座號綁定</title>
  <style>
    body { font-family: 'Microsoft JhengHei',sans-serif; max-width:600px; margin:0 auto; padding:16px; background:#f5f5f5 }
    .container { background:#fff; padding:18px; border-radius:8px }
    .welcome { background:#e8f4ff; border:1px solid #787b77; padding:10px; border-radius:6px; color:#008062; margin-bottom:12px }
    label { display:block; margin-top:12px; font-weight:600 }
    input, select, button { width:100%; padding:10px; box-sizing:border-box }
    button { margin-top:12px; background:#008062; color:#fff; border:0; padding:12px; border-radius:6px }
  </style>
  <!-- 配置：把下面的 EXEC_URL 改成你的 Apps Script exec URL，例如 https://script.google.com/macros/s/AKfy.../exec -->
  <script>
    const EXEC_URL = 'https://script.google.com/macros/s/AKfycbzQ1q2sKLIjRRlKCTUCubycSMbg_gw6ZpHG3muTOZx_KwZ_JsK6sTj0qe7njLhowuUh9A/exec';
  </script>
</head>
<body>
    <div class="container">
      <h1>座號綁定</h1>
  <div class="welcome" id="pageInfo">嗨，朋友（ID: N/A） ，歡迎來到座號綁定頁面！
      <div style="margin-top:6px; color:#666; font-size:13px">請選擇學生座號，系統會自動帶出學生姓名；填寫家長資料後送出即可完成綁定。</div>
  </div>
  <pre id="debugProfile" style="display:none;visibility:hidden;height:0;margin:0;padding:0;overflow:hidden"></pre>

      <form id="seatBindingForm">
        <label for="seatNumber">學生座號</label>
        <select id="seatNumber"><option value="">請選擇座號</option></select>

  <!-- 學生姓名由後端根據座號查回，前端不顯示此欄位 -->

        <label for="parentName">家長姓名</label>
        <input id="parentName" />

        <label for="parentEmail">家長email</label>
        <input id="parentEmail" />

        <label for="parentPhone">家長手機</label>
        <input id="parentPhone" />

        <label for="relation">關係</label>
        <select id="relation">
          <option value="">請選擇關係</option>
          <option value="父親">父親</option>
          <option value="母親">母親</option>
          <option value="監護人">監護人</option>
          <option value="阿公/阿嬤">阿公/阿嬤</option>
          <option value="其他">其他</option>
        </select>

        <div style="margin-top:12px"><button id="submitBtn" type="button">送出綁定</button></div>
        <div id="result" style="margin-top:12px; padding:10px; border-radius:6px; display:none;
          background:#f0f8f4; color:#064; border:1px solid #cfe9df"></div>
      </form>

      
  </div>

  <script>
  (function(){
    const VERSION_URL = './version.txt';
    const LIFF_ID = '2008280587-XzrRkkO4';
    const EXEC = typeof EXEC_URL !== 'undefined' ? EXEC_URL : '';

    // insert update banner
    var banner = document.createElement('div');
    banner.id = 'updateBanner';
    banner.style.cssText = 'display:none;position:fixed;left:0;right:0;top:0;z-index:9999;padding:10px;background:#fffbe6;border-bottom:1px solid #ffd966;text-align:center';
    banner.innerHTML = '偵測到新版本可用，請 <button id="reloadBtn" style="margin-left:8px;padding:6px 8px;border-radius:4px">重新整理</button>';
    document.body.insertBefore(banner, document.body.firstChild);
    document.addEventListener('click', function(e){ if(e.target && e.target.id==='reloadBtn'){ location.reload(true); } });

    async function fetchVersion(){
      try{
        const res = await fetch(VERSION_URL + '?_=' + Date.now(), {cache: 'no-store'});
        if (!res.ok) return null;
        return (await res.text()).trim();
      } catch(e){ return null; }
    }

    // dynamic load LIFF SDK with cache-busting
    function loadLiffSdk(ver){
      return new Promise(function(resolve,reject){
        if (window.liff) return resolve();
        var s = document.createElement('script');
        s.async = true;
        s.src = 'https://static.line-scdn.net/liff/edge/2/sdk.js' + (ver ? '?cb=' + encodeURIComponent(ver) : '?_=' + Date.now());
        s.onload = function(){ resolve(); };
        s.onerror = function(){ reject(new Error('LIFF SDK load failed')); };
        document.head.appendChild(s);
      });
    }

    (async function main(){
      const currentVer = await fetchVersion();
      try { if (currentVer) localStorage.setItem('app_build_version', currentVer); } catch(e){}

      // poll for version changes every 20s
      setInterval(async function(){
        const v = await fetchVersion();
        const stored = localStorage.getItem('app_build_version') || '';
        if (v && stored && v !== stored) {
          document.getElementById('updateBanner').style.display = 'block';
        }
      }, 20000);

      // always load student list (independent of LIFF)
      try{
        const r = await fetch(EXEC + '?action=getStudentList&_=' + Date.now());
        const js = await r.json();
        if (js && js.success && js.data) {
          var sel = document.getElementById('seatNumber');
          js.data.sort(function(a,b){ return Number(a.seat) - Number(b.seat); });
          js.data.forEach(function(it){ var opt = document.createElement('option'); opt.value = it.seat; opt.textContent = it.seat; sel.appendChild(opt); });
        }
      } catch(e){ console.log('getStudentList failed', e); }

      // attempt to load LIFF SDK and init
      try{
        await loadLiffSdk(currentVer || Date.now());
        if (window.liff) {
          try{
            await liff.init({ liffId: LIFF_ID });
          } catch(e){ console.log('liff.init error', e); }

          var inClient = liff.isInClient()?true:false;
          var loggedIn = liff.isLoggedIn()?true:false;

          if (inClient || loggedIn) {
            try{
              var profile = await liff.getProfile();
              // do not display full profile JSON or userId on the page for privacy
              // keep debugProfile hidden; still send a minimal server log
              // send to server log (fire and forget)
              fetch(EXEC, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action:'logLiffInit', gotProfile:true, profile:profile, clientTs:Date.now() }) }).catch(function(e){});
              // populate fields
              var u = document.createElement('input'); u.type='hidden'; u.id='liffUserId'; u.value=profile.userId; document.getElementById('seatBindingForm').appendChild(u);
              var n = document.createElement('input'); n.type='hidden'; n.id='liffDisplayName'; n.value=profile.displayName; document.getElementById('seatBindingForm').appendChild(n);
              // show only displayName (no userId)
              document.getElementById('pageInfo').innerHTML = '嗨，' + (profile.displayName||'朋友') + '，歡迎來到座號綁定頁面！' + '<div style="margin-top:6px; color:#666; font-size:13px">請選擇學生座號，系統會自動帶出學生姓名；填寫家長資料後送出即可完成綁定。</div>';
            } catch(err){
              // keep profile errors hidden from UI; log to server for debugging
              var dbg = document.getElementById('debugProfile'); dbg.style.visibility='hidden'; dbg.textContent = 'liff.getProfile error:\n' + (err && err.message ? err.message : String(err));
              fetch(EXEC, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action:'logLiffInit', getProfileError: (err && err.message) ? err.message : String(err), clientTs:Date.now() }) }).catch(function(e){});
            }
          }
        }
      } catch(err){ console.log('liff load/init error', err); }

    })();

    // submit handler with pre-submit ping to server
    document.getElementById('submitBtn').addEventListener('click', async function(){
      var submitBtn = document.getElementById('submitBtn');
      var seatNumber = document.getElementById('seatNumber').value;
      var parentName = document.getElementById('parentName').value;
      var resultEl = document.getElementById('result');
      if (!seatNumber) { alert('請先選擇學生座號'); return; }
      if (!parentName) { alert('請輸入家長姓名'); return; }

      // ping server with a quick GET to ensure endpoint reachable before POST
      try{
        resultEl.style.display = 'block'; resultEl.textContent = '檢查伺服器連線中...';
        const pingResp = await fetch(EXEC + '?action=getStudentList&_=' + Date.now(), { method:'GET', cache:'no-store' });
        if (!pingResp.ok) {
          resultEl.textContent = '伺服器回應異常，無法送出（HTTP ' + pingResp.status + '）';
          return;
        }
        // optionally parse to ensure JSON
        try { await pingResp.clone().json(); } catch(e) { resultEl.textContent = '伺服器回傳非 JSON，無法送出'; return; }
      } catch(pingErr) {
        resultEl.style.display = 'block'; resultEl.textContent = '無法連線到後端：' + (pingErr && pingErr.message ? pingErr.message : String(pingErr));
        return;
      }

      var liffUserIdEl = document.getElementById('liffUserId');
      var liffDisplayNameEl = document.getElementById('liffDisplayName');
      var liffUserId = liffUserIdEl ? liffUserIdEl.value : '';
      var liffDisplayName = liffDisplayNameEl ? liffDisplayNameEl.value : '';

      var payload = {
        action: 'submitSeatBinding',
        seatNumber: seatNumber,
        seat: seatNumber,
        parentName: parentName,
        parentEmail: document.getElementById('parentEmail').value,
        parentPhone: document.getElementById('parentPhone').value,
        relation: document.getElementById('relation')?document.getElementById('relation').value:'',
        liffUserId: liffUserId,
        liffDisplayName: liffDisplayName,
        fromLiff: !!liffUserId
      };

      // disable button to prevent double submit
      submitBtn.disabled = true;
      resultEl.style.display = 'none';

      // use form-encoded body to avoid CORS preflight (some hosts block OPTIONS)
      var formBody = new URLSearchParams();
      Object.keys(payload).forEach(function(k){ formBody.append(k, String(payload[k] === undefined ? '' : payload[k])); });
      try{
        const r = await fetch(EXEC, { method:'POST', headers:{ 'Content-Type':'application/x-www-form-urlencoded' }, body: formBody.toString() });
        const js = await r.json();
        resultEl.style.display = 'block';
        resultEl.textContent = '提交結果：' + JSON.stringify(js);
      } catch(e){
        resultEl.style.display = 'block';
        resultEl.textContent = '提交失敗：' + (e && e.message ? e.message : String(e));
      } finally {
        submitBtn.disabled = false;
        resultEl.scrollIntoView({ behavior: 'smooth' });
      }
    });

  })();
  </script>
</body>
</html>
