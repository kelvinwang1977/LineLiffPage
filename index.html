<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>座號綁定</title>
  <style>
    body { font-family: 'Microsoft JhengHei',sans-serif; max-width:600px; margin:0 auto; padding:16px; background:#f5f5f5 }
    .container { background:#fff; padding:18px; border-radius:8px }
    .welcome { background:#e8f4ff; border:1px solid #d9edd4; padding:10px; border-radius:6px; color:#008062; margin-bottom:12px }
    label { display:block; margin-top:12px; font-weight:600 }
    input, select, button { width:100%; padding:10px; box-sizing:border-box }
    button { margin-top:12px; background:#008062; color:#fff; border:0; padding:12px; border-radius:6px }
  </style>
  <!-- 配置：把下面的 EXEC_URL 改成你的 Apps Script exec URL，例如 https://script.google.com/macros/s/AKfy.../exec -->
  <script>
    const EXEC_URL = 'https://script.google.com/macros/s/AKfycbzQ1q2sKLIjRRlKCTUCubycSMbg_gw6ZpHG3muTOZx_KwZ_JsK6sTj0qe7njLhowuUh9A/exec';
  </script>
</head>
<body>
    <div class="container">
      <h1>座號綁定</h1>
      <div class="welcome" id="pageInfo">Loading...</div>
      <div id="liffStatus" style="display:none; margin-bottom:8px;">LIFF 狀態：<span id="liffStatusText">初始化中...</span></div>
      <pre id="debugProfile" style="display:none;"></pre>

      <form id="seatBindingForm">
        <label for="seatNumber">學生座號</label>
        <select id="seatNumber"><option value="">請選擇座號</option></select>

        <label for="studentName">學生姓名</label>
        <input id="studentName" />

        <label for="parentName">家長姓名</label>
        <input id="parentName" />

        <label for="parentEmail">家長email</label>
        <input id="parentEmail" />

        <label for="parentPhone">家長手機</label>
        <input id="parentPhone" />

        <label for="relation">關係</label>
        <input id="relation" />

        <div style="margin-top:12px"><button id="submitBtn" type="button">送出綁定</button></div>
      </form>

      <div style="margin-top:12px">
        <button id="showLiffBtn">顯示 LIFF 資訊</button>
      </div>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
    // page info
    document.addEventListener('DOMContentLoaded', function(){
      var pi = document.getElementById('pageInfo');
      var out = [];
      out.push('PAGE_MARKER=SEATBINDING_PAGE_LOADED');
      out.push('href=' + window.location.href);
      out.push('referrer=' + document.referrer);
      out.push('ua=' + (navigator.userAgent||''));
      pi.textContent = out.join('\n');
    });

    (function(){
      var LIFF_ID = '2008280587-XzrRkkO4';
      liff.init({ liffId: LIFF_ID }).then(function(){
        var inClient = liff.isInClient()?true:false;
        var loggedIn = liff.isLoggedIn()?true:false;
        document.getElementById('liffStatus').style.display = 'block';
        document.getElementById('liffStatusText').textContent = 'inClient=' + inClient + ' isLoggedIn=' + loggedIn;

        if (inClient || loggedIn) {
          liff.getProfile().then(function(profile){
            document.getElementById('debugProfile').style.display='block';
            document.getElementById('debugProfile').textContent = JSON.stringify(profile, null, 2);
            // send to server log
            fetch(EXEC_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action:'logLiffInit', gotProfile:true, profile:profile, clientTs:Date.now() }) }).catch(function(e){ console.log('post logLiffInit failed', e); });
            // populate fields
            var u = document.createElement('input'); u.type='hidden'; u.id='liffUserId'; u.value=profile.userId; document.getElementById('seatBindingForm').appendChild(u);
            var n = document.createElement('input'); n.type='hidden'; n.id='liffDisplayName'; n.value=profile.displayName; document.getElementById('seatBindingForm').appendChild(n);
            // also show in pageInfo
            document.getElementById('pageInfo').textContent = '歡迎，' + (profile.displayName||'') + '（ID:' + (profile.userId||'') + '）';
          }).catch(function(err){
            var dbg = document.getElementById('debugProfile'); dbg.style.display='block'; dbg.textContent = 'liff.getProfile error:\n' + (err && err.message ? err.message : String(err));
            fetch(EXEC_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action:'logLiffInit', getProfileError: (err && err.message) ? err.message : String(err), clientTs:Date.now() }) }).catch(function(e){ console.log('post error report failed', e); });
          });
        }
      }).catch(function(e){ console.log('liff.init error', e); });
    })();

    document.getElementById('submitBtn').addEventListener('click', function(){
      var payload = {
        action:'submitSeatBinding',
        seatNumber:document.getElementById('seatNumber').value,
        studentName:document.getElementById('studentName').value,
        parentName:document.getElementById('parentName').value,
        parentEmail:document.getElementById('parentEmail').value,
        parentPhone:document.getElementById('parentPhone').value,
        relation:document.getElementById('relation')?document.getElementById('relation').value:'',
        liffUserId: (document.getElementById('liffUserId')?document.getElementById('liffUserId').value:''),
        liffDisplayName: (document.getElementById('liffDisplayName')?document.getElementById('liffDisplayName').value:'')
      };
      fetch(EXEC_URL, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) }).then(function(r){ return r.json(); }).then(function(js){ alert('提交結果: ' + JSON.stringify(js)); }).catch(function(e){ alert('提交失敗: ' + e); });
    });

    document.getElementById('showLiffBtn').addEventListener('click', function(){
      alert('liffUserId:' + (document.getElementById('liffUserId')?document.getElementById('liffUserId').value:'') + '\n' + 'liffDisplayName:' + (document.getElementById('liffDisplayName')?document.getElementById('liffDisplayName').value:''));
    });

    document.getElementById('debugBtn').addEventListener('click', function(){
      // attempt to get idToken and show detailed profile/error
      Promise.resolve().then(function(){
        return liff.getIDToken().then(function(idt){
          var s = 'idToken:\n' + (idt || 'empty');
          try { alert(s); } catch(e) { console.log(s); }
        }).catch(function(e){
          alert('getIDToken error: ' + (e && e.message ? e.message : String(e)));
        });
      }).then(function(){
        return liff.getProfile().then(function(profile){
          var dbg = document.getElementById('debugProfile'); dbg.style.display='block'; dbg.textContent = 'Profile (debug button):\n' + JSON.stringify(profile, null, 2);
        }).catch(function(err){
          var dbg = document.getElementById('debugProfile'); dbg.style.display='block';
          var errObj = { message: err && err.message ? err.message : String(err), name: err && err.name ? err.name : '', stack: err && err.stack ? err.stack : null };
          dbg.textContent = 'liff.getProfile error (from debug button):\n' + JSON.stringify(errObj, null, 2);
          alert('liff.getProfile error:\n' + (err && err.message ? err.message : String(err)));
        });
      }).catch(function(e){ console.log('debugBtn overall error', e); });
    });
  </script>
</body>
</html>
