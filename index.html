<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>座號綁定</title>
  <style>
    body { font-family: 'Microsoft JhengHei',sans-serif; max-width:600px; margin:0 auto; padding:16px; background:#f5f5f5 }
    .container { background:#fff; padding:18px; border-radius:8px }
    .welcome { background:#e8f4ff; border:1px solid #787b77; padding:10px; border-radius:6px; color:#008062; margin-bottom:12px }
    label { display:block; margin-top:12px; font-weight:600 }
    input, select, button { width:100%; padding:10px; box-sizing:border-box }
    button { margin-top:12px; background:#008062; color:#fff; border:0; padding:12px; border-radius:6px }
  </style>
  <!-- 配置：把下面的 EXEC_URL 改成你的 Apps Script exec URL，例如 https://script.google.com/macros/s/AKfy.../exec -->
  <script>
    const EXEC_URL = 'https://script.google.com/macros/s/AKfycbzQ1q2sKLIjRRlKCTUCubycSMbg_gw6ZpHG3muTOZx_KwZ_JsK6sTj0qe7njLhowuUh9A/exec';
  </script>
</head>
<body>
    <div class="container">
      <h1>座號綁定</h1>
  <div class="welcome" id="pageInfo">嗨，朋友（ID: N/A） ，歡迎來到座號綁定頁面！
      <div style="margin-top:6px; color:#666; font-size:13px">請選擇學生座號，系統會自動帶出學生姓名；填寫家長資料後送出即可完成綁定。</div>
  </div>
      <pre id="debugProfile" style="display:none;"></pre>

      <form id="seatBindingForm">
        <label for="seatNumber">學生座號</label>
        <select id="seatNumber"><option value="">請選擇座號</option></select>

  <!-- 學生姓名由後端根據座號查回，前端不顯示此欄位 -->

        <label for="parentName">家長姓名</label>
        <input id="parentName" />

        <label for="parentEmail">家長email</label>
        <input id="parentEmail" />

        <label for="parentPhone">家長手機</label>
        <input id="parentPhone" />

        <label for="relation">關係</label>
        <input id="relation" />

        <div style="margin-top:12px"><button id="submitBtn" type="button">送出綁定</button></div>
      </form>

      
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>

  (function(){
      var LIFF_ID = '2008280587-XzrRkkO4';
      liff.init({ liffId: LIFF_ID }).then(function(){
        var inClient = liff.isInClient()?true:false;
          var loggedIn = liff.isLoggedIn()?true:false;

        if (inClient || loggedIn) {
          liff.getProfile().then(function(profile){
            document.getElementById('debugProfile').style.display='block';
            document.getElementById('debugProfile').textContent = JSON.stringify(profile, null, 2);
            // send to server log
            fetch(EXEC_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action:'logLiffInit', gotProfile:true, profile:profile, clientTs:Date.now() }) }).catch(function(e){ console.log('post logLiffInit failed', e); });
            // populate fields
            var u = document.createElement('input'); u.type='hidden'; u.id='liffUserId'; u.value=profile.userId; document.getElementById('seatBindingForm').appendChild(u);
            var n = document.createElement('input'); n.type='hidden'; n.id='liffDisplayName'; n.value=profile.displayName; document.getElementById('seatBindingForm').appendChild(n);
            // also show in pageInfo using requested wording
            document.getElementById('pageInfo').innerHTML = '嗨，' + (profile.displayName||'朋友') + '（ID: ' + (profile.userId||'N/A') + '） ，歡迎來到座號綁定頁面！' +
              '<div style="margin-top:6px; color:#666; font-size:13px">請選擇學生座號，系統會自動帶出學生姓名；填寫家長資料後送出即可完成綁定。</div>';
          }).catch(function(err){
            var dbg = document.getElementById('debugProfile'); dbg.style.display='block'; dbg.textContent = 'liff.getProfile error:\n' + (err && err.message ? err.message : String(err));
            fetch(EXEC_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action:'logLiffInit', getProfileError: (err && err.message) ? err.message : String(err), clientTs:Date.now() }) }).catch(function(e){ console.log('post error report failed', e); });
          });
        }

        // 另外，載入學生座號清單供選擇（來自 Apps Script GET API）
        fetch(EXEC_URL + '?action=getStudentList').then(function(r){ return r.json(); }).then(function(js){
          if (js && js.success && js.data) {
            var sel = document.getElementById('seatNumber');
            js.data.sort(function(a,b){ return Number(a.seat) - Number(b.seat); });
            js.data.forEach(function(it){
              var opt = document.createElement('option'); opt.value = it.seat; opt.textContent = it.seat + ' - ' + it.name; sel.appendChild(opt);
            });
          }
        }).catch(function(e){ console.log('getStudentList failed', e); });
      }).catch(function(e){ console.log('liff.init error', e); });
    })();

    document.getElementById('submitBtn').addEventListener('click', function(){
      var payload = {
        action:'submitSeatBinding',
        seatNumber:document.getElementById('seatNumber').value,
        studentName:document.getElementById('studentName').value,
        parentName:document.getElementById('parentName').value,
        parentEmail:document.getElementById('parentEmail').value,
        parentPhone:document.getElementById('parentPhone').value,
        relation:document.getElementById('relation')?document.getElementById('relation').value:'',
        liffUserId: (document.getElementById('liffUserId')?document.getElementById('liffUserId').value:''),
        liffDisplayName: (document.getElementById('liffDisplayName')?document.getElementById('liffDisplayName').value:'')
      };
      fetch(EXEC_URL, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) }).then(function(r){ return r.json(); }).then(function(js){ alert('提交結果: ' + JSON.stringify(js)); }).catch(function(e){ alert('提交失敗: ' + e); });
    });

    
  </script>
</body>
</html>
