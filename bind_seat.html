<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ç·Šæ€¥è¯çµ¡è³‡æ–™è¡¨</title>
  <style>
    body { font-family: 'Microsoft JhengHei',sans-serif; max-width:600px; margin:0 auto; padding:16px; background:#f5f5f5 }
    .container { background:#fff; padding:18px; border-radius:8px }
    .welcome { background:#e4faf4; border:1px solid #787b77; padding:10px; border-radius:6px; color:#008062; margin-bottom:12px }
    label { display:block; margin-top:12px; font-weight:600 }
    input, select, button { width:100%; padding:10px; box-sizing:border-box }
    button { margin-top:12px; background:#008062; color:#fff; border:0; padding:12px; border-radius:6px }
  </style>
  <!-- é…ç½®ï¼šæŠŠä¸‹é¢çš„ EXEC_URL æ”¹æˆä½ çš„ Apps Script exec URLï¼Œä¾‹å¦‚ https://script.google.com/macros/s/AKfy.../exec -->
  <script>
    const EXEC_URL = 'https://script.google.com/macros/s/AKfycbwY_xlH-_IBshMRLlxm8tAEVCrBlrh6OZqEBxfZ_6PK3RDKEAwVNJSeV4LIxR9zYxJuBQ/exec';
  </script>
</head>
<body>
    <div class="container">
  <div class="welcome" id="pageInfo">å—¨ï¼Œæœ‹å‹ï¼ˆID: N/Aï¼‰ ï¼Œè«‹æä¾›å®¶è¯çµ¡è³‡æ–™ï¼
      <div style="margin-top:6px; color:#666; font-size:13px">è«‹é¸æ“‡å­¸ç”Ÿåº§è™Ÿï¼Œå¡«å¯«å®¶é•·è³‡æ–™å¾Œé€å‡ºã€‚</div>
  </div>
  <pre id="debugProfile" style="display:none;visibility:hidden;height:0;margin:0;padding:0;overflow:hidden"></pre>

    <form id="seatBindingForm">
  <label for="seatNumber">å­¸ç”Ÿåº§è™Ÿ</label>
  <select id="seatNumber"><option value="">è«‹é¸æ“‡åº§è™Ÿ</option></select>
  

  <!-- å­¸ç”Ÿå§“åç”±å¾Œç«¯æ ¹æ“šåº§è™ŸæŸ¥å›ï¼Œå‰ç«¯ä¸é¡¯ç¤ºæ­¤æ¬„ä½ -->

        <label for="parentName">å®¶é•·å§“å</label>
        <input id="parentName" />

        <label for="parentEmail">å®¶é•·email</label>
        <input id="parentEmail" />

        <label for="parentPhone">å®¶é•·æ‰‹æ©Ÿ</label>
        <input id="parentPhone" />

        <label for="relation">é—œä¿‚</label>
        <select id="relation">
          <option value="">è«‹é¸æ“‡é—œä¿‚</option>
          <option value="çˆ¶è¦ª">çˆ¶è¦ª</option>
          <option value="æ¯è¦ª">æ¯è¦ª</option>
          <option value="ç›£è­·äºº">ç›£è­·äºº</option>
          <option value="é˜¿å…¬/é˜¿å¬¤">é˜¿å…¬/é˜¿å¬¤</option>
          <option value="å…¶ä»–">å…¶ä»–</option>
        </select>

        <div style="margin-top:12px"><button id="submitBtn" type="button">é€å‡ºç¶å®š</button></div>
        <div id="result" style="margin-top:12px; padding:10px; border-radius:6px; display:none;
          background:#f0f8f4; color:#064; border:1px solid #cfe9df"></div>
      </form>

      
  </div>

  <script>
  (function(){
    const VERSION_URL = './version.txt';
    const LIFF_ID = '2008280587-XzrRkkO4';
    const EXEC = typeof EXEC_URL !== 'undefined' ? EXEC_URL : '';

    // insert update banner
    var banner = document.createElement('div');
    banner.id = 'updateBanner';
    banner.style.cssText = 'display:none;position:fixed;left:0;right:0;top:0;z-index:9999;padding:10px;background:#fffbe6;border-bottom:1px solid #ffd966;text-align:center';
    banner.innerHTML = 'åµæ¸¬åˆ°æ–°ç‰ˆæœ¬å¯ç”¨ï¼Œè«‹ <button id="reloadBtn" style="margin-left:8px;padding:6px 8px;border-radius:4px">é‡æ–°æ•´ç†</button>';
    document.body.insertBefore(banner, document.body.firstChild);
    document.addEventListener('click', function(e){ if(e.target && e.target.id==='reloadBtn'){ location.reload(true); } });

    async function fetchVersion(){
      try{
        const res = await fetch(VERSION_URL + '?_=' + Date.now(), {cache: 'no-store'});
        if (!res.ok) return null;
        return (await res.text()).trim();
      } catch(e){ return null; }
    }

    // dynamic load LIFF SDK with cache-busting
    function loadLiffSdk(ver){
      return new Promise(function(resolve,reject){
        if (window.liff) return resolve();
        var s = document.createElement('script');
        s.async = true;
        s.src = 'https://static.line-scdn.net/liff/edge/2/sdk.js' + (ver ? '?cb=' + encodeURIComponent(ver) : '?_=' + Date.now());
        s.onload = function(){ resolve(); };
        s.onerror = function(){ reject(new Error('LIFF SDK load failed')); };
        document.head.appendChild(s);
      });
    }

    // small helper to escape HTML when rendering server responses for diagnostics
    function escapeHtml(s){
      if (!s) return '';
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }

    // submit via hidden form + iframe to work around fetch CORS issues in some in-app browsers
    function submitViaForm(payload){
      try{
        // cleanup previous
        var existing = document.getElementById('post_target_iframe');
        if (existing) existing.parentNode.removeChild(existing);

        var iframe = document.createElement('iframe');
        iframe.name = 'post_target'; iframe.id = 'post_target_iframe'; iframe.style.display = 'none';
        document.body.appendChild(iframe);

        var form = document.createElement('form');
        form.method = 'POST'; form.action = EXEC; form.target = iframe.name; form.style.display = 'none';
        Object.keys(payload).forEach(function(k){
          var inp = document.createElement('input'); inp.type='hidden'; inp.name = k; inp.value = String(payload[k] === undefined ? '' : payload[k]); form.appendChild(inp);
        });
        document.body.appendChild(form);

        // when iframe finishes loading (server responded), show result and attempt to send a LIFF message
        iframe.onload = async function(){
          try{
            var resEl = document.getElementById('result');
            if (resEl) { resEl.style.display = 'block'; resEl.textContent = 'å·²æˆåŠŸé€å‡ºï¼Œæ„Ÿè¬æ‚¨çš„å›å ±ã€‚'; }
            var sb = document.getElementById('submitBtn'); if (sb) sb.disabled = false;

            // å¦‚æœåœ¨ LIFF å…§ï¼Œå˜—è©¦ç”¨ liff.sendMessages() ç™¼é€ç¶å®šå®Œæˆè¨Šæ¯ï¼ˆåŒ…å«å­¸ç”Ÿå§“åèˆ‡è¡¨å–®æ¬„ä½ï¼‰ï¼Œå†é—œé–‰ LIFF
            try {
              if (window.liff && typeof window.liff.sendMessages === 'function' && liff.isInClient && liff.isInClient()) {
                try {
                  // build a nicer, easy-to-read Flex bubble with labeled rows and friendly emoji
                  var flexContents = {
                    type: 'bubble',
                    header: {
                      type: 'box',
                      layout: 'vertical',
                      contents: [
                        { type: 'text', text: 'ğŸ‰ æ‚¨çš„è¯çµ¡è³‡æ–™å·²ç™»è¨˜', weight: 'bold', size: 'lg', color: '#006400' }
                      ]
                    },
                    body: {
                      type: 'box',
                      layout: 'vertical',
                      spacing: 'sm',
                      contents: [
                        { type: 'box', layout: 'baseline', spacing: 'sm', contents: [ { type: 'text', text: 'åº§è™Ÿ', color: '#111111', size: 'sm', weight: 'bold', flex: 2 }, { type: 'text', text: escapeHtml(payload.seat || '-'), color: '#333333', size: 'sm', align: 'end', flex: 3 } ] },
                        { type: 'box', layout: 'baseline', spacing: 'sm', contents: [ { type: 'text', text: 'å­¸ç”Ÿ', color: '#111111', size: 'sm', weight: 'bold', flex: 2 }, { type: 'text', text: escapeHtml(payload.studentName || '-'), color: '#333333', size: 'sm', align: 'end', flex: 3 } ] },
                        { type: 'box', layout: 'baseline', spacing: 'sm', contents: [ { type: 'text', text: 'å®¶é•·', color: '#111111', size: 'sm', weight: 'bold', flex: 2 }, { type: 'text', text: escapeHtml(payload.parentName || '-'), color: '#333333', size: 'sm', align: 'end', flex: 3 } ] },
                        { type: 'box', layout: 'baseline', spacing: 'sm', contents: [ { type: 'text', text: 'æ‰‹æ©Ÿ', color: '#111111', size: 'sm', weight: 'bold', flex: 2 }, { type: 'text', text: escapeHtml(payload.parentPhone || '-'), color: '#333333', size: 'sm', align: 'end', flex: 3 } ] },
                        { type: 'box', layout: 'baseline', spacing: 'sm', contents: [ { type: 'text', text: 'é—œä¿‚', color: '#111111', size: 'sm', weight: 'bold', flex: 2 }, { type: 'text', text: escapeHtml(payload.relation || '-'), color: '#333333', size: 'sm', align: 'end', flex: 3 } ] }
                      ]
                    },
                    footer: {
                      type: 'box',
                      layout: 'vertical',
                      contents: [
                        { type: 'text', text: 'æ„Ÿè¬æ‚¨çš„å›å ± ğŸ™ è‹¥éœ€ä¿®æ”¹è«‹å†å›ä¾†å‘Šè¨´æˆ‘å€‘ã€‚', size: 'xs', color: '#888888', wrap: true }
                      ]
                    }
                  };

                  await liff.sendMessages([ { type: 'flex', altText: 'æ‚¨çš„è¯çµ¡è³‡æ–™å·²ç™»è¨˜', contents: flexContents } ]);
                  // close LIFF view after sending
                  if (typeof liff.closeWindow === 'function') { liff.closeWindow(); return; }
                } catch(sendErr) {
                  console.log('liff.sendMessages (flex) error', sendErr);
                }
              }
            } catch (closeErr) {
              console.log('liff send/close error', closeErr);
            }

            // å˜—è©¦é—œé–‰ä¸€èˆ¬ç€è¦½å™¨æ¨™ç±¤é ï¼ˆéƒ¨åˆ†ç€è¦½å™¨å¯èƒ½æœƒè¢«é˜»æ“‹ï¼‰
            try {
              window.close();
            } catch (wcErr) {
              console.log('window.close failed', wcErr);
            }

          } catch(e){console.log(e);} 
          setTimeout(function(){ try{ iframe.parentNode.removeChild(iframe); form.parentNode.removeChild(form);}catch(e){} }, 1200);
        };

        // submit
        form.submit();
      } catch(err){ console.log('submitViaForm error', err); var sb2 = document.getElementById('submitBtn'); if (sb2) sb2.disabled = false; }
    }

    (async function main(){
      const currentVer = await fetchVersion();
      try { if (currentVer) localStorage.setItem('app_build_version', currentVer); } catch(e){}

      // poll for version changes every 20s
      setInterval(async function(){
        const v = await fetchVersion();
        const stored = localStorage.getItem('app_build_version') || '';
        if (v && stored && v !== stored) {
          document.getElementById('updateBanner').style.display = 'block';
        }
      }, 20000);

      // ä½¿ç”¨å›ºå®šåº§è™Ÿé™£åˆ—ï¼Œä¸å†å‘å¾Œç«¯æŸ¥è¡¨ï¼Œä¹Ÿä¸é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
      (function populateSeatList(){
        var sel = document.getElementById('seatNumber');
        try{
          var seats = [
            '1','2','3','4','5','6','7','8','9','10','11','12','13','14',
            '21','22','23','24','26','27','28','29','30','31','32','33','34','35','36'
          ];
          // clear existing options except first
          while (sel.options.length>1) sel.remove(1);
          seats.forEach(function(s){ var opt = document.createElement('option'); opt.value = s; opt.text = s; sel.appendChild(opt); });
          sel.style.display = ''; sel.disabled = false; sel.options[0].text = 'è«‹é¸æ“‡åº§è™Ÿ';
        } catch(e){
          console.log('populateSeatList error', e);
        }
      })();

      // attempt to load LIFF SDK and init
      try{
        await loadLiffSdk(currentVer || Date.now());
        if (window.liff) {
          try{
            await liff.init({ liffId: LIFF_ID });
          } catch(e){ console.log('liff.init error', e); }

          var inClient = liff.isInClient()?true:false;
          var loggedIn = liff.isLoggedIn()?true:false;

          if (inClient || loggedIn) {
            try{
              var profile = await liff.getProfile();
              // do not display full profile JSON or userId on the page for privacy
              // keep debugProfile hidden; still send a minimal server log
              // send to server log (fire and forget)
              fetch(EXEC, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action:'logLiffInit', gotProfile:true, profile:profile, clientTs:Date.now() }) }).catch(function(e){});
              // populate fields
              var u = document.createElement('input'); u.type='hidden'; u.id='liffUserId'; u.value=profile.userId; document.getElementById('seatBindingForm').appendChild(u);
              var n = document.createElement('input'); n.type='hidden'; n.id='liffDisplayName'; n.value=profile.displayName; document.getElementById('seatBindingForm').appendChild(n);
              // show only displayName (no userId)
              document.getElementById('pageInfo').innerHTML = 'å—¨ï¼Œ' + (profile.displayName||'æœ‹å‹') + 'ï¼Œæ­¡è¿ä¾†åˆ°åº§è™Ÿç¶å®šé é¢ï¼' + '<div style="margin-top:6px; color:#666; font-size:13px">è«‹é¸æ“‡å­¸ç”Ÿåº§è™Ÿï¼Œç³»çµ±æœƒè‡ªå‹•å¸¶å‡ºå­¸ç”Ÿå§“åï¼›å¡«å¯«å®¶é•·è³‡æ–™å¾Œé€å‡ºå³å¯å®Œæˆç¶å®šã€‚</div>';
            } catch(err){
              // keep profile errors hidden from UI; log to server for debugging
              var dbg = document.getElementById('debugProfile'); dbg.style.visibility='hidden'; dbg.textContent = 'liff.getProfile error:\n' + (err && err.message ? err.message : String(err));
              fetch(EXEC, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action:'logLiffInit', getProfileError: (err && err.message) ? err.message : String(err), clientTs:Date.now() }) }).catch(function(e){});
            }
          }
        }
      } catch(err){ console.log('liff load/init error', err); }

    })();

    // submit handler with pre-submit ping to server
    document.getElementById('submitBtn').addEventListener('click', async function(){
      var submitBtn = document.getElementById('submitBtn');
      var seatNumber = document.getElementById('seatNumber').value;
      var parentName = document.getElementById('parentName').value;
      var resultEl = document.getElementById('result');
      if (!seatNumber) { alert('è«‹å…ˆé¸æ“‡å­¸ç”Ÿåº§è™Ÿ'); return; }
      if (!parentName) { alert('è«‹è¼¸å…¥å®¶é•·å§“å'); return; }

      // ping server with a quick GET to ensure endpoint reachable before POST
      try{
        resultEl.style.display = 'block'; resultEl.textContent = 'æª¢æŸ¥ä¼ºæœå™¨é€£ç·šä¸­...';
        const pingResp = await fetch(EXEC + '?action=getStudentList&_=' + Date.now(), { method:'GET', cache:'no-store' });
        if (!pingResp.ok) {
          var txt = '';
          try { txt = await pingResp.text(); } catch(e) { txt = '(ç„¡æ³•è®€å–å›æ‡‰å…§æ–‡)'; }
          resultEl.textContent = 'ä¼ºæœå™¨å›æ‡‰ç•°å¸¸ï¼Œç„¡æ³•é€å‡ºï¼ˆHTTP ' + pingResp.status + 'ï¼‰\n' + txt;
          console.log('Ping failed: status=', pingResp.status, 'body=', txt);
          return;
        }
        // parse student list JSON so we can include studentName in the payload
        var studentNameFromServer = '';
        try {
          var listJson = await pingResp.clone().json();
          // API returns {success:true, data: [...] }
          var arr = (listJson && listJson.data) ? listJson.data : (Array.isArray(listJson) ? listJson : []);
          if (Array.isArray(arr)) {
            for (var i=0;i<arr.length;i++){
              var r = arr[i];
              // r may be object {seat, name} or array; handle both
              var s = r && (r.seat || (r[0]||''));
              var n = r && (r.name || (r[1]||''));
              if (String(s) === String(seatNumber)) { studentNameFromServer = n || ''; break; }
            }
          }
        } catch(e) {
          var txt2 = '';
          try { txt2 = await pingResp.clone().text(); } catch(er) { txt2 = '(ç„¡æ³•è®€å–å›æ‡‰å…§æ–‡)'; }
          resultEl.textContent = 'ä¼ºæœå™¨å›å‚³é JSONï¼Œç„¡æ³•é€å‡º\n' + txt2;
          console.log('Ping returned non-JSON body:', txt2);
          return;
        }
      } catch(pingErr) {
        resultEl.style.display = 'block'; resultEl.textContent = 'ç„¡æ³•é€£ç·šåˆ°å¾Œç«¯ï¼š' + (pingErr && pingErr.message ? pingErr.message : String(pingErr));
        console.log('Ping exception:', pingErr);
        return;
      }

      var liffUserIdEl = document.getElementById('liffUserId');
      var liffDisplayNameEl = document.getElementById('liffDisplayName');
      var liffUserId = liffUserIdEl ? liffUserIdEl.value : '';
      var liffDisplayName = liffDisplayNameEl ? liffDisplayNameEl.value : '';

      var payload = {
        action: 'submitSeatBinding',
        seatNumber: seatNumber,
        seat: seatNumber,
        parentName: parentName,
        studentName: (typeof studentNameFromServer !== 'undefined' ? studentNameFromServer : ''),
        parentEmail: document.getElementById('parentEmail').value,
        parentPhone: document.getElementById('parentPhone').value,
        relation: document.getElementById('relation')?document.getElementById('relation').value:'',
        liffUserId: liffUserId,
        liffDisplayName: liffDisplayName,
        fromLiff: !!liffUserId
      };

      // disable button to prevent double submit
      submitBtn.disabled = true;
      resultEl.style.display = 'none';

      // submit via hidden form + iframe to avoid fetch CORS issues in some in-app browsers
      try {
        submitViaForm(payload);
      } catch(e) {
        resultEl.style.display = 'block';
        resultEl.textContent = 'æäº¤å¤±æ•—ï¼ˆæœ¬åœ°æäº¤éŒ¯èª¤ï¼‰ï¼š' + (e && e.message ? e.message : String(e));
        console.log('submitViaForm exception:', e);
        submitBtn.disabled = false;
      }
    });

    

  })();
  </script>
</body>
</html>
