<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>座號綁定</title>
  <style>
    body { font-family: 'Microsoft JhengHei',sans-serif; max-width:600px; margin:0 auto; padding:16px; background:#f5f5f5 }
    .container { background:#fff; padding:18px; border-radius:8px }
    .welcome { background:#e8f4ff; border:1px solid #787b77; padding:10px; border-radius:6px; color:#008062; margin-bottom:12px }
    label { display:block; margin-top:12px; font-weight:600 }
    input, select, button { width:100%; padding:10px; box-sizing:border-box }
    button { margin-top:12px; background:#008062; color:#fff; border:0; padding:12px; border-radius:6px }
  </style>
  <!-- 配置：把下面的 EXEC_URL 改成你的 Apps Script exec URL，例如 https://script.google.com/macros/s/AKfy.../exec -->
  <script>
    const EXEC_URL = 'https://script.google.com/macros/s/AKfycbwY_xlH-_IBshMRLlxm8tAEVCrBlrh6OZqEBxfZ_6PK3RDKEAwVNJSeV4LIxR9zYxJuBQ/exec';
  </script>
</head>
<body>
    <div class="container">
      <h1>緊急聯絡資料表</h1>
  <div class="welcome" id="pageInfo">嗨，朋友（ID: N/A） ，請提供家聯絡資料！
      <div style="margin-top:6px; color:#666; font-size:13px">請選擇學生座號，填寫家長資料後送出即可完成綁定。</div>
  </div>
  <pre id="debugProfile" style="display:none;visibility:hidden;height:0;margin:0;padding:0;overflow:hidden"></pre>

    <form id="seatBindingForm">
  <label for="seatNumber">學生座號</label>
  <select id="seatNumber"><option value="">請選擇座號</option></select>
  <div id="seatLoadStatus" style="margin-top:8px;font-size:13px;color:#666;display:none"></div>

  <!-- 學生姓名由後端根據座號查回，前端不顯示此欄位 -->

        <label for="parentName">家長姓名</label>
        <input id="parentName" />

        <label for="parentEmail">家長email</label>
        <input id="parentEmail" />

        <label for="parentPhone">家長手機</label>
        <input id="parentPhone" />

        <label for="relation">關係</label>
        <select id="relation">
          <option value="">請選擇關係</option>
          <option value="父親">父親</option>
          <option value="母親">母親</option>
          <option value="監護人">監護人</option>
          <option value="阿公/阿嬤">阿公/阿嬤</option>
          <option value="其他">其他</option>
        </select>

        <div style="margin-top:12px"><button id="submitBtn" type="button">送出綁定</button></div>
        <div id="result" style="margin-top:12px; padding:10px; border-radius:6px; display:none;
          background:#f0f8f4; color:#064; border:1px solid #cfe9df"></div>
      </form>

      
  </div>

  <script>
  (function(){
    const VERSION_URL = './version.txt';
    const LIFF_ID = '2008280587-XzrRkkO4';
    const EXEC = typeof EXEC_URL !== 'undefined' ? EXEC_URL : '';

    // insert update banner
    var banner = document.createElement('div');
    banner.id = 'updateBanner';
    banner.style.cssText = 'display:none;position:fixed;left:0;right:0;top:0;z-index:9999;padding:10px;background:#fffbe6;border-bottom:1px solid #ffd966;text-align:center';
    banner.innerHTML = '偵測到新版本可用，請 <button id="reloadBtn" style="margin-left:8px;padding:6px 8px;border-radius:4px">重新整理</button>';
    document.body.insertBefore(banner, document.body.firstChild);
    document.addEventListener('click', function(e){ if(e.target && e.target.id==='reloadBtn'){ location.reload(true); } });

    async function fetchVersion(){
      try{
        const res = await fetch(VERSION_URL + '?_=' + Date.now(), {cache: 'no-store'});
        if (!res.ok) return null;
        return (await res.text()).trim();
      } catch(e){ return null; }
    }

    // dynamic load LIFF SDK with cache-busting
    function loadLiffSdk(ver){
      return new Promise(function(resolve,reject){
        if (window.liff) return resolve();
        var s = document.createElement('script');
        s.async = true;
        s.src = 'https://static.line-scdn.net/liff/edge/2/sdk.js' + (ver ? '?cb=' + encodeURIComponent(ver) : '?_=' + Date.now());
        s.onload = function(){ resolve(); };
        s.onerror = function(){ reject(new Error('LIFF SDK load failed')); };
        document.head.appendChild(s);
      });
    }

    // small helper to escape HTML when rendering server responses for diagnostics
    function escapeHtml(s){
      if (!s) return '';
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }

    // submit via hidden form + iframe to work around fetch CORS issues in some in-app browsers
    function submitViaForm(payload){
      try{
        // cleanup previous
        var existing = document.getElementById('post_target_iframe');
        if (existing) existing.parentNode.removeChild(existing);

        var iframe = document.createElement('iframe');
        iframe.name = 'post_target'; iframe.id = 'post_target_iframe'; iframe.style.display = 'none';
        document.body.appendChild(iframe);

        var form = document.createElement('form');
        form.method = 'POST'; form.action = EXEC; form.target = iframe.name; form.style.display = 'none';
        Object.keys(payload).forEach(function(k){
          var inp = document.createElement('input'); inp.type='hidden'; inp.name = k; inp.value = String(payload[k] === undefined ? '' : payload[k]); form.appendChild(inp);
        });
        document.body.appendChild(form);

        iframe.onload = function(){
          try{
            var resEl = document.getElementById('result');
            if (resEl) { resEl.style.display = 'block'; resEl.textContent = '提交完成（伺服器可能已處理） — 若需確認請檢查後端試算表或 incoming_api_log'; }
            var sb = document.getElementById('submitBtn'); if (sb) sb.disabled = false;
          } catch(e){}
          setTimeout(function(){ try{ iframe.parentNode.removeChild(iframe); form.parentNode.removeChild(form);}catch(e){} }, 1200);
        };

        // submit
        form.submit();
      } catch(err){ console.log('submitViaForm error', err); var sb2 = document.getElementById('submitBtn'); if (sb2) sb2.disabled = false; }
    }

    (async function main(){
      const currentVer = await fetchVersion();
      try { if (currentVer) localStorage.setItem('app_build_version', currentVer); } catch(e){}

      // poll for version changes every 20s
      setInterval(async function(){
        const v = await fetchVersion();
        const stored = localStorage.getItem('app_build_version') || '';
        if (v && stored && v !== stored) {
          document.getElementById('updateBanner').style.display = 'block';
        }
      }, 20000);

      // always load student list (independent of LIFF)
      async function loadStudentList(){
        var sel = document.getElementById('seatNumber');
        var status = document.getElementById('seatLoadStatus');
        try{
          if (!EXEC || EXEC.length === 0) {
            if (status) { status.style.display = 'block'; status.innerHTML = '未設定後端執行網址（EXEC_URL）。請在 <code>index.html</code> 設定 Apps Script exec URL。'; }
            return;
          }
          if (status) { status.style.display = 'block'; status.textContent = '載入座號中...'; }
          // add cache-bust
          const r = await fetch(EXEC + '?action=getStudentList&_=' + Date.now(), { method: 'GET', cache: 'no-store' });
          if (!r.ok) {
            var body = '';
            try { body = await r.text(); } catch(e) { body = '(無法讀取回應)'; }
            if (status) {
              status.innerHTML = '載入座號失敗（HTTP ' + r.status + '）<br/>' + (body.length>200? body.slice(0,200)+'...': body) + '<br/>' + '<button id="retrySeat" style="margin-top:8px;padding:6px">重新載入座號</button>' + '<pre style="margin-top:8px;white-space:pre-wrap;color:#333;font-size:12px">' + escapeHtml(body.slice(0,1000)) + '</pre>';
              var rb = document.getElementById('retrySeat'); if (rb) rb.addEventListener('click', loadStudentList);
            }
            return;
          }
          var js = null;
          try { js = await r.json(); } catch(jsonErr) {
            var txt = '';
            try { txt = await r.text(); } catch(e) { txt = '(無法讀取回應)'; }
            if (status) status.innerHTML = '載入座號失敗（回傳非 JSON）<br/>' + '<pre style="white-space:pre-wrap;color:#333;font-size:12px">' + escapeHtml(txt.slice(0,1000)) + '</pre>' + '<br/><button id="retrySeat" style="margin-top:8px;padding:6px">重新載入座號</button>';
            var rbj = document.getElementById('retrySeat'); if (rbj) rbj.addEventListener('click', loadStudentList);
            return;
          }
          // clear existing options except first
          while (sel.options.length>1) sel.remove(1);
          if (js && js.success && js.data && js.data.length>0) {
            // robust sort: numeric if possible, otherwise string
            js.data.sort(function(a,b){
              var an = Number(a.seat), bn = Number(b.seat);
              if (!isNaN(an) && !isNaN(bn)) return an - bn;
              var as = String(a.seat||''); var bs = String(b.seat||''); return as.localeCompare(bs, 'zh-Hant-u-co-pinyin');
            });
            js.data.forEach(function(it){ var opt = document.createElement('option'); opt.value = it.seat; opt.text = String(it.seat); sel.appendChild(opt); });
            // ensure select visible and enabled
            sel.style.display = ''; sel.disabled = false; sel.options[0].text = '請選擇座號';
            if (status) { status.textContent = '已載入 ' + js.data.length + ' 個座號'; setTimeout(function(){ if (status) status.style.display='none'; }, 1200); }
          } else {
            if (status) {
              status.innerHTML = '沒有可用的座號資料。<br/><button id="retrySeat" style="margin-top:8px;padding:6px">重新載入座號</button>';
              var rb2 = document.getElementById('retrySeat'); if (rb2) rb2.addEventListener('click', loadStudentList);
            }
          }
        } catch(e){
          console.log('getStudentList failed', e);
          if (status) {
            status.innerHTML = '載入座號失敗（網路或伺服器錯誤）：' + escapeHtml(String(e && e.message ? e.message : e)) + '<br/><button id="retrySeat" style="margin-top:8px;padding:6px">重新載入座號</button>';
            var rb3 = document.getElementById('retrySeat'); if (rb3) rb3.addEventListener('click', loadStudentList);
          }
        }
      }
      // invoke initial load
      loadStudentList();

      // attempt to load LIFF SDK and init
      try{
        await loadLiffSdk(currentVer || Date.now());
        if (window.liff) {
          try{
            await liff.init({ liffId: LIFF_ID });
          } catch(e){ console.log('liff.init error', e); }

          var inClient = liff.isInClient()?true:false;
          var loggedIn = liff.isLoggedIn()?true:false;

          if (inClient || loggedIn) {
            try{
              var profile = await liff.getProfile();
              // do not display full profile JSON or userId on the page for privacy
              // keep debugProfile hidden; still send a minimal server log
              // send to server log (fire and forget)
              fetch(EXEC, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action:'logLiffInit', gotProfile:true, profile:profile, clientTs:Date.now() }) }).catch(function(e){});
              // populate fields
              var u = document.createElement('input'); u.type='hidden'; u.id='liffUserId'; u.value=profile.userId; document.getElementById('seatBindingForm').appendChild(u);
              var n = document.createElement('input'); n.type='hidden'; n.id='liffDisplayName'; n.value=profile.displayName; document.getElementById('seatBindingForm').appendChild(n);
              // show only displayName (no userId)
              document.getElementById('pageInfo').innerHTML = '嗨，' + (profile.displayName||'朋友') + '，歡迎來到座號綁定頁面！' + '<div style="margin-top:6px; color:#666; font-size:13px">請選擇學生座號，系統會自動帶出學生姓名；填寫家長資料後送出即可完成綁定。</div>';
            } catch(err){
              // keep profile errors hidden from UI; log to server for debugging
              var dbg = document.getElementById('debugProfile'); dbg.style.visibility='hidden'; dbg.textContent = 'liff.getProfile error:\n' + (err && err.message ? err.message : String(err));
              fetch(EXEC, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action:'logLiffInit', getProfileError: (err && err.message) ? err.message : String(err), clientTs:Date.now() }) }).catch(function(e){});
            }
          }
        }
      } catch(err){ console.log('liff load/init error', err); }

    })();

    // submit handler with pre-submit ping to server
    document.getElementById('submitBtn').addEventListener('click', async function(){
      var submitBtn = document.getElementById('submitBtn');
      var seatNumber = document.getElementById('seatNumber').value;
      var parentName = document.getElementById('parentName').value;
      var resultEl = document.getElementById('result');
      if (!seatNumber) { alert('請先選擇學生座號'); return; }
      if (!parentName) { alert('請輸入家長姓名'); return; }

      // ping server with a quick GET to ensure endpoint reachable before POST
      try{
        resultEl.style.display = 'block'; resultEl.textContent = '檢查伺服器連線中...';
        const pingResp = await fetch(EXEC + '?action=getStudentList&_=' + Date.now(), { method:'GET', cache:'no-store' });
        if (!pingResp.ok) {
          var txt = '';
          try { txt = await pingResp.text(); } catch(e) { txt = '(無法讀取回應內文)'; }
          resultEl.textContent = '伺服器回應異常，無法送出（HTTP ' + pingResp.status + '）\n' + txt;
          console.log('Ping failed: status=', pingResp.status, 'body=', txt);
          return;
        }
        // optionally parse to ensure JSON
        try { await pingResp.clone().json(); } catch(e) {
          var txt2 = '';
          try { txt2 = await pingResp.clone().text(); } catch(er) { txt2 = '(無法讀取回應內文)'; }
          resultEl.textContent = '伺服器回傳非 JSON，無法送出\n' + txt2;
          console.log('Ping returned non-JSON body:', txt2);
          return;
        }
      } catch(pingErr) {
        resultEl.style.display = 'block'; resultEl.textContent = '無法連線到後端：' + (pingErr && pingErr.message ? pingErr.message : String(pingErr));
        console.log('Ping exception:', pingErr);
        return;
      }

      var liffUserIdEl = document.getElementById('liffUserId');
      var liffDisplayNameEl = document.getElementById('liffDisplayName');
      var liffUserId = liffUserIdEl ? liffUserIdEl.value : '';
      var liffDisplayName = liffDisplayNameEl ? liffDisplayNameEl.value : '';

      var payload = {
        action: 'submitSeatBinding',
        seatNumber: seatNumber,
        seat: seatNumber,
        parentName: parentName,
        parentEmail: document.getElementById('parentEmail').value,
        parentPhone: document.getElementById('parentPhone').value,
        relation: document.getElementById('relation')?document.getElementById('relation').value:'',
        liffUserId: liffUserId,
        liffDisplayName: liffDisplayName,
        fromLiff: !!liffUserId
      };

      // disable button to prevent double submit
      submitBtn.disabled = true;
      resultEl.style.display = 'none';

      // submit via hidden form + iframe to avoid fetch CORS issues in some in-app browsers
      try {
        submitViaForm(payload);
      } catch(e) {
        resultEl.style.display = 'block';
        resultEl.textContent = '提交失敗（本地提交錯誤）：' + (e && e.message ? e.message : String(e));
        console.log('submitViaForm exception:', e);
        submitBtn.disabled = false;
      }
    });

    

  })();
  </script>
</body>
</html>
